name: Auto Export Archi

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Export Diagrams via Archi
        run: |
          $archiPath = "C:\Program Files\Archi\Archi.exe"
          $modelPath = "$env:GITHUB_WORKSPACE\model"
          $exportPath = "$env:GITHUB_WORKSPACE\exports"

          New-Item -ItemType Directory -Force -Path $exportPath | Out-Null

          Start-Process -FilePath $archiPath -ArgumentList @(
            "-application", "com.archimatetool.commandline.app",
            "-nosplash",
            "--loadModel", $modelPath,
            "--exportImages",
            "format=PNG",
            "scale=2.0",
            "folder=$exportPath"
          ) -Wait -NoNewWindow

          Write-Host "=== Hasil export ==="
          $pngs = Get-ChildItem $exportPath -Filter "*.png"
          if ($pngs.Count -eq 0) {
            Write-Host "Tidak ada file PNG dihasilkan"
          } else {
            $pngs | ForEach-Object { Write-Host "  ✅ $($_.Name)" }
          }
        shell: pwsh

      - name: Commit & Push PNG
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add -f exports/
          $diff = git diff --cached --name-only
          if ($diff) {
            git commit -m "ci: auto export diagrams to PNG [skip ci]"
            git push
            Write-Host "✅ PNG berhasil di-push ke GitHub"
          } else {
            Write-Host "Tidak ada perubahan, skip commit."
          }
        shell: pwsh
